<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MyLink25-ParkReviews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="home.css" />
<script src="./js/bikes.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body onload="checkUserStatus()">
    <div class="navbar">
      <div class="nav-left">
        <div class="logo">&nbsp&nbspMyLink - Park Reviews</div>
      </div>
      <div class="nav-right">
        <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
        <span id="H3UserBanner">User</span>
        <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
        <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
        <a href="cart5.html" id="cartBtn" class="btn secondary-btn" onclick="checkUser(event)">Cart</a>
      </div>
    </div>
  <div class="container py-5">
    <h1 class="mb-4 text-center">Park Reviews</h1>

    <!-- Park Summary Card -->
    <div id="park-details" class="mb-5"></div>

    <!-- Review Header and Add Button -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Visitor Reviews</h4>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">Add Review</button>
    </div>

    <!-- Reviews Grid -->
    <div id="reviews-grid" class="row g-4"></div>
  </div>

  <!-- Review Modal -->
  <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="review-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewModalLabel">Submit a Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="userId" class="form-label">Your User ID</label>
            <input type="number" class="form-control" id="userId" required>
          </div>
          <div class="mb-3">
            <label for="stars" class="form-label">Rating</label>
            <select class="form-select" id="stars" required>
              <option value="">Choose...</option>
              <option value="5">★★★★★</option>
              <option value="4">★★★★☆</option>
              <option value="3">★★★☆☆</option>
              <option value="2">★★☆☆☆</option>
              <option value="1">★☆☆☆☆</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Review</label>
            <textarea class="form-control" id="description" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Submit Review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function () {
      const params = new URLSearchParams(window.location.search);
      const parkId = params.get("parkId");

      if (!parkId) {
        $("#park-details").html(`<div class="alert alert-danger">No parkId provided in URL.</div>`);
        return;
      }

      // Load park info
      $.get(`https://gridactions3b.547bikes.info/api/Parks/${parkId}`, function (park) {
        if (Array.isArray(park)) park = park[0];
        if (!park) {
          $("#park-details").html(`<div class="alert alert-warning">No park found for ID ${parkId}.</div>`);
          return;
        }

        $("#park-details").html(`
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center mb-3">
                ${park.parklogourl ? `<img src="${park.parklogourl}" alt="Park Logo" class="me-3" style="height:60px;">` : ""}
                <h3 class="card-title mb-0">${park.name}</h3>
              </div>
              <p><strong>Region:</strong> ${park.region}</p>
              <p><strong>Address:</strong> ${park.address}</p>
              <p><strong>Phone:</strong> ${park.phone}</p>
              <p><strong>Trail Length:</strong> ${park.trailLengthMiles} miles</p>
              <p><strong>Difficulty:</strong> ${park.difficulty}</p>
              <p><strong>Day Pass:</strong> $${park.dayPassPriceUsd.toFixed(2)}</p>
              <p><strong>Description:</strong> ${park.description}</p>
              <p><strong>GPS:</strong> ${park.latitude}, ${park.longitude}</p>
              <p><strong>Visitors:</strong> ${park.currentvisitors} / ${park.maxvisitors} (Adults: ${park.currentvisitorsadults}, Children: ${park.currentvisitorschildren})</p>
              <p><strong>Campsites:</strong> ${park.currentcampsites || 0} / ${park.maxcampsites}</p>
              ${park.trailmapurl ? `<a href="${park.trailmapurl}" class="btn btn-primary btn-sm mt-2" target="_blank">Trail Map</a>` : `<span class="text-muted">No trail map available</span>`}
              <a href="https://www.google.com/maps?q=${park.latitude},${park.longitude}" class="btn btn-outline-secondary btn-sm mt-2 ms-2" target="_blank">Open in Google Maps</a>
            </div>
          </div>
        `);
      });

      // Load reviews
      function loadReviews() {
        $.get("https://gridactions3b.547bikes.info/api/ParkReview", function (reviews) {
          const filtered = reviews.filter(r => r.parkId == parkId);
          if (filtered.length === 0) {
            $("#reviews-grid").html(`<div class="col-12"><p class="text-muted">No reviews yet.</p></div>`);
            return;
          }

          $("#reviews-grid").html(filtered.map(r => `
            <div class="col-md-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">User #${r.userId}</h5>
                  <p class="text-warning">${"★".repeat(r.stars)}${"☆".repeat(5 - r.stars)}</p>
                  <p class="card-text">${r.description}</p>
                  <p class="text-muted small">Posted: ${new Date(r.datePosted).toLocaleDateString()}</p>
                </div>
              </div>
            </div>
          `).join(""));
        });
      }

      loadReviews();

      // Submit review
      $("#review-form").on("submit", function (e) {
        e.preventDefault();

        const review = {
          parkId: parseInt(parkId),
          userId: parseInt($("#userId").val()),
          description: $("#description").val(),
          stars: parseInt($("#stars").val()),
          datePosted: new Date().toISOString(),
          dateApproved: null,
          dateDenied: null,
          reasonDescription: null,
          reviewManagerId: null
        };

        $.ajax({
          url: "https://gridactions3b.547bikes.info/api/ParkReview",
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify(review),
          success: function () {
            $("#reviewModal").modal("hide");
            $("#review-form")[0].reset();
            loadReviews();
          },
          error: function () {
            alert("Failed to submit review.");
          }
        });
      });
    });
  </script>
</body>
  <footer class="footer">
    &copy; Cocky Consulting 2025. <br> All rights reserved.<br>
    <span align="center"><a href="sitemap.html" class="sitelink">SiteMap</a></span>
  </footer>
</html>
