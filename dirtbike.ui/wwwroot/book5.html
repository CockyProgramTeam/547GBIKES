<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="login.css" />
  <link rel="stylesheet" href="dropmenu.css" />
  <script src="./js/bikes.js"></script>
  <title>Mountain Bike Parks</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    #userGreeting {
      text-align: center;
      vertical-align: middle;
      color: white;
    }
    #banner {
      background-color: lightgrey;
      height: 60px;
      vertical-align: middle;
      width: 100%;
    }
    #cancelBtn {
      width: 400px;
    }
    #splash {
      font-size: 12pt;
    }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: flex;
      gap: 40px;
      justify-content: center;
    }
    .panel {
      width: 40%;
    }
    .panel h2 {
      text-align: center;
    }
    select {
      width: 100%;
      height: 300px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 10px;
    }
    button {
      padding: 10px;
      font-size: 16px;
      width: 90px;
    }
  
    #newcartbutton
  {
  width: 100%;
  }
  .compact-dropdown {
  height: auto;
  max-height: 38px;
  overflow-y: hidden;
}
  
  #currentParkId
  {
  float: right;
  }
  #someparkid
  {
  float: right:
  }
  
  #productselector
  {
  background-color: lightgrey;
  width: 100%;
  }
  
  </style>
</head>
<body onload="checkpll(); checkUserStatus(); displayProfilePicture(); LoadNewCart(); loadParkSummary(); setDates();">
  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/jsmenu4.png"></button> 
        <div class="dropdown-content">
          <a href="index.html">Site Home</a>
          <a href="cart5.html">MyCart</a>
          <a href="mybookings5.html">MyReservations</a>
          <a href="manager.html">Manager Utilities</a>
        </div>
      </div> 
      <div class="logo">&nbsp;&nbsp;MyLinkv25 - Review Parks</div>
    </div>
    <div class="nav-right">
      <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
      <span id="H3UserBanner"></span>
      <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
      <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
      <a href="cart5.html?uid=1" id="cartBtn" class="btn secondary-btn" onclick="checkUser(event)">Cart</a>
    </div>
  </div>

  <div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div>

  <!-- CartMaster Summary Card -->
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Left Column: Park Summary (2/3 width) -->
    <div class="col-lg-8" id="parks-container">
      <!-- Park cards will be injected here -->
    <div id="park-details" class="mb-2"></div>  
  </div>

 <div class="col-lg-4" style="height: 100%;">
  <div style="height: 100%; display: flex; flex-direction: column; gap: 20px;">
    
    <!-- Selected Park Card -->
    <div class="card border-info" style="height: 155px; overflow-y: auto;">
      <div class="card-header bg-info text-white py-2 px-3 small">
        <span id="someparkid"><strong>Current Park ID:</strong></span>
        <span id="currentParkId" class="fw-semibold"></span><br>
      </div>
      <div class="card-body" style="display: flex; align-items: center; gap: 10px;">
  <label for="parkSelector" class="form-label small mb-0">Change Park:</label>
  <select id="parkSelector" class="form-select form-select-sm"
    style="max-width: 280px; max-height: 80px; font-size: 0.85rem; padding: 2px 8px;"
    onchange="changePark()">
    <option value="">Select a Park</option>
  </select>
</div>
    </div>

    <!-- Cart Summary Card -->
   <div class="card text-white bg-primary mb-4" id="cartMasterCard" style="max-height:320px; overflow-y:auto; display:none;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="text-center w-100">
      Your Cart Master Summary For User: <span id="masterowner"></span>
    </div>
  </div>
  <div class="card-body">
    <p class="card-text">
      Loyalty ID: <span id="loyaltyid"></span><br>
      Carts Count: <span id="cmCartsCount"></span><br>
      Active Carts: <span id="cmCartsActive"></span><br>
      Cancelled Carts: <span id="cmCartsCancelled"></span><br>
      Active List: <span id="cmCartsActiveList" style="max-height:100px;"></span>
    </p>
    <br>
    <span id="currentParkName"></span>
    <div>
      <button id="newcartbutton" class="btn btn-light" onclick="createNewCart()">Add New Cart</button>
    </div>
  </div>
</div>

  </div>
</div>
</div>
<div id="productselector">
<HR>
  <div class="container">
    <div class="panel">
    <span align="center"><h4>Available Park Items</h4></span>
      <select id="catalogue" multiple></select>
    </div>
    <div class="controls">
     <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
      <label for="globalStartDate" class="form-label mb-0">Start:</label>
      <input type="date" id="globalStartDate" class="form-control form-control-sm" style="max-width: 140px;" />

      <label for="globalEndDate" class="form-label mb-0">End:</label>
      <input type="date" id="globalEndDate" class="form-control form-control-sm" style="max-width: 140px;" />
    </div>
    <div align="center"><button onclick="moveToSelected()">Add Item(s)</button> <button onclick="moveToCatalogue()">Remove Items(s)</button>&nbsp&nbsp<button onclick="addSelectedToCart()">Add to Cart</button></div>
    </div>
    <div class="panel">
      <span align="center"><h4>Selected Items</h4></span>
      <select id="selected" multiple></select>
    </div><BR><BR>
  </div><BR><BR>
<HR>
</div>
<script>
 
  const baseUrl = "https://gridactions3b.547bikes.info";
  const cardApi = `${baseUrl}/api/Card`;
  const paymentApi = `${baseUrl}/api/Payments`;
  const cartApi = `${baseUrl}/api/Cart`;
  const API_ROOT = 'https://gridactions3b.547bikes.info';
  const uid = localStorage.getItem('uid');
  const urlParams = new URLSearchParams(window.location.search);
  let parkId = parseInt(urlParams.get('parkId')) || 0;
  let cartId = null;
  let catalogueItems = [];
  let someparkid = parkId;
  let someparkname = "somepark";


function setDates() {
  const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
  document.getElementById('globalStartDate').value = today;
  document.getElementById('globalEndDate').value = today;
}


  async function ensureCartMasterExists() {
    const response = await fetch(`${API_ROOT}/api/CartMaster?userId=${uid}`);
    const masters = await response.json();

    if (masters.length === 0) {
      const newMaster = {
        userId: uid,
        cartsCount: 0,
        cartsCancelled: 0,
        cartsActive: 0,
        cartsActiveList: ""
      };

      await fetch(`${API_ROOT}/api/CartMaster`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newMaster)
      });
    }
  }

//THIS IS CORRECT TO HERE....

  async function displayCartMaster() {
    const response = await fetch(`${API_ROOT}/api/CartMaster?userId=${uid}`);
    const masters = await response.json();

    if (masters.length > 0) {
      const master = masters[0];
      document.getElementById('cmCartsCount').textContent = master.cartsCount;
      document.getElementById('cmCartsActive').textContent = master.cartsActive;
      document.getElementById('cmCartsCancelled').textContent = master.cartsCancelled;
      document.getElementById('cmCartsActiveList').textContent = master.cartsActiveList;
      document.getElementById('cartMasterCard').style.display = 'block';
      document.getElementById('masterowner').innerHTML = master.userId;
     }
  
  }

//THIS IS CORRECT TO HERE....


  async function createNewCart() {
    const generatedCartId = Math.floor(Math.random() * 1000000);
    cartId = generatedCartId;
    const today = new Date().toISOString().split('T')[0];
  
    const newCart = {
    cartId: generatedCartId,
    uid: uid, // assumed to be defined elsewhere
    parkId: parkId, // assumed to be defined elsewhere
    itemType: "Combination",
    itemDescription: "2 Separate Products",
    quantity: 0,
    unitPrice: 0,
    totalPrice: 0,
    dateAdded: new Date().toISOString().split("T")[0], // format: YYYY-MM-DD
    isCheckedOut: 0,
    paymentid: "",
    bookinginfo: "[33,34]",
    totalcartitems: 0,
    multipleitems: 0,
    johnstotals: 0,
    transactiontotal: 0,
    resStart: today,
    resEnd: today
  };

    try {
      const response = await fetch(`${API_ROOT}/api/Cart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCart)
      });

      const text = await response.text();

      if (response.status !== 201) {
        console.error('Cart creation failed:', response.status);
        alert('Failed to create cart.');
        return;
      }

      let createdCart;
      try {
        createdCart = text ? JSON.parse(text) : {};
      } catch (err) {
        console.warn('Response body not valid JSON:', text);
        createdCart = {};
      }

      cartId = createdCart.cartId || generatedCartId;
      console.log('Cart created with ID:', cartId);

      const masterRes = await fetch(`${API_ROOT}/api/CartMaster?userId=${uid}`);
      const masters = await masterRes.json();
      if (masters.length > 0) {
        const master = masters[0];
        const updatedList = master.cartsActiveList
          ? `${master.cartsActiveList},${cartId}`
          : `${cartId}`;

        const updatedMaster = {
          ...master,
          cartsCount: master.cartsCount + 1,
          cartsActive: master.cartsActive + 1,
          cartsActiveList: updatedList
        };

        await fetch(`${API_ROOT}/api/CartMaster/${master.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedMaster)
        });

        console.log('CartMaster updated with new cart:', updatedMaster);
        await displayCartMaster();
      }
    } catch (error) {
      console.error('Unexpected error during cart creation:', error);
      alert('An unexpected error occurred while creating the cart.');
    }
  }

//THIS IS CORRECT TO HERE....
async function loadCatalogue() {
  try {
    const response = await fetch(`https://gridactions3b.547bikes.info/api/SalesCatalogue/park/${parkId}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    const catalogueItems = await response.json();
    console.log("✅ Catalogue items:", catalogueItems);

    // Sort items alphabetically by description
    catalogueItems.sort((a, b) => (a.description || '').localeCompare(b.description || ''));

    const catalogueSelect = document.getElementById('catalogue');
    catalogueSelect.innerHTML = '';

    catalogueItems.forEach(item => {
      const description = item.description || 'Unnamed Item';
      const price = typeof item.price === 'number' ? item.price : 0;
      const priceText = price > 0 ? `$${price.toFixed(2)}` : 'Free';

      const option = document.createElement('option');
      option.value = item.salesCatalogueId;
      option.text = `${description}, ${priceText}`;
      option.dataset.vendor = item.serviceType || 'Unknown';
      option.dataset.price = price.toFixed(2);
      option.dataset.salescatid = item.salesCatalogueId;

      // Optional styling for free items
      if (price === 0) {
        option.style.color = 'green';
        option.text += ' (Free)';
      }

      catalogueSelect.appendChild(option);
    });
  } catch (error) {
    console.error("❌ Failed to load catalogue:", error);
  }
}
/*
 async function loadCatalogue() {
  try {
    const response = await fetch(`https://gridactions3b.547bikes.info/api/SalesCatalogue/park/${parkId}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    
    const catalogueItems = await response.json();
    console.log("✅ Catalogue items:", catalogueItems);

    const catalogueSelect = document.getElementById('catalogue');
    catalogueSelect.innerHTML = '';

    catalogueItems.forEach(item => {
      const description = item.description || 'Unnamed Item';
      const priceText = typeof item.price === 'number' ? `$${item.price.toFixed(2)}` : 'Price N/A';

      const option = document.createElement('option');
      option.value = item.salesCatalogueId;
      option.text = `${description}, ${priceText}`;
      option.dataset.vendor = item.serviceType || '';
      option.dataset.price = typeof item.price === 'number' ? item.price.toFixed(2) : "0.00";
      option.dataset.salescatid = item.salesCatalogueId;

      catalogueSelect.appendChild(option);
    });
  } catch (error) {
    console.error("❌ Failed to load catalogue:", error);
  }
}*/
//THIS IS CORRECT TO HERE....

  async function loadParksDropdown() {
    const response = await fetch(`${API_ROOT}/api/Parks`);
    const parks = await response.json();

    const selector = document.getElementById('parkSelector');
    selector.innerHTML = '<option value="">Select a Park</option>';
    parks.forEach(park => {
      const option = document.createElement('option');
      option.value = park.parkId;
      option.textContent = `${park.name} (ID: ${park.parkId})`;
      selector.appendChild(option);
    });

    document.getElementById('currentParkId').textContent = parkId;
    const currentPark = parks.find(p => p.parkId === parkId);
    document.getElementById('currentParkName').textContent = currentPark ? currentPark.parkName : 'Unknown';
    someparkname = currentPark;
  }

  function changePark() {
    const newParkId = document.getElementById('parkSelector').value;
    if (!newParkId) return;

    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set('parkId', newParkId);
    window.history.pushState({}, '', newUrl);

    parkId = parseInt(newParkId);
    document.getElementById('currentParkId').textContent = parkId;
    loadParkSummary();
    loadCatalogue();
  }

//THIS IS CORRECT TO HERE....

  function moveToSelected() {
    const catalogue = document.getElementById('catalogue');
    const selected = document.getElementById('selected');
    Array.from(catalogue.selectedOptions).forEach(option => {
      catalogue.removeChild(option);
      selected.appendChild(option);
    });
  }

//THIS IS CORRECT TO HERE....
  function moveToCatalogue() {
    const catalogue = document.getElementById('catalogue');
    const selected = document.getElementById('selected');
    Array.from(selected.selectedOptions).forEach(option => {
      selected.removeChild(option);
      catalogue.appendChild(option);
    });
  }

async function loadParkSummary() {
    const parkDetails = document.getElementById("park-details");
    if (!parkId) {
      parkDetails.innerHTML = `<div class="alert alert-danger">No parkId provided in URL.</div>`;
      return;
    }

    $.ajax({
      url: `${API_ROOT}/api/Parks/${parkId}`,
      method: "GET",
      success: function (data) {
        const park = Array.isArray(data) ? data[0] : data;
        if (!park) {
          parkDetails.innerHTML = `<div class="alert alert-warning">No park found for ID ${parkId}.</div>`;
          return;
        }
        	const trailMapLink = park.trailmapurl
              ? `<a href="${park.trailmapurl}" class="btn btn-primary btn-sm mt-2" target="_blank">Trail Map</a>`
              : `<span class="text-muted">No trail map available</span>`;
            const mapsLink = `https://www.google.com/maps?q=${park.latitude},${park.longitude}`;
			const directionsLink = `https://www.google.com/maps/dir/?api=1&destination=${park.latitude},${park.longitude}`;
            const pictureurl = `https://ww2.547bikes.info/picturewall.html?parkId=${park.parkId}`;

        parkDetails.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body">
              <h3 class="card-title">${park.name}</h3>
              <p><strong>Region:</strong> ${park.region}</p>
              <p><strong>Address:</strong> ${park.address}</p>
              <p><strong>Phone:</strong> ${park.phone}</p>
              <p><strong>Trail Length:</strong> ${park.trailLengthMiles} miles</p>
              <p><strong>Difficulty:</strong> ${park.difficulty}</p>
              <p><strong>Day Pass:</strong> $${typeof park.dayPassPriceUsd === "number" ? park.dayPassPriceUsd.toFixed(2) : "N/A"}</p>
              <p><strong>Description:</strong> ${park.description}</p>
              <p><strong>GPS:</strong> ${park.latitude}, ${park.longitude}</p>
              <span>&nbsp&nbsp${trailMapLink}<br>
                    <a href="book5.html?parkId=${park.parkId}" class="btn btn-success btn-sm mt-2 ms-2">Book This Park</a><br>
                    <a href="${mapsLink}" class="btn btn-outline-secondary btn-sm mt-2 ms-2" target="_blank">Open in Google Maps</a>
                    <a href="${directionsLink}" class="btn btn-outline-primary btn-sm mt-2 ms-2" target="_blank">Get Driving Directions</a>
                    <br>
                    <a href="reviews5.html?parkId=${park.parkId}" class="btn btn-outline-secondary btn-sm mt-2 ms-2" target="_blank">See Reviews Of This Park</a>
					<a href="${pictureurl}" class="btn btn-outline-primary btn-sm mt-2 ms-2" target="_blank">View Park Pictures</a><br>
					</span>
            </div>
          </div>
        `;
      },
      error: function (xhr, status, error) {
        console.error("❌ Error loading park:", status, error);
        parkDetails.innerHTML = `<div class="alert alert-danger">Error loading park details: ${error}</div>`;
      }
    });
  }
  async function LoadNewCart() {
    if (!uid) {
      alert("No UID found in localStorage. Please log in.");
      return;
    }

    await ensureCartMasterExists();
    await displayCartMaster();
    await createNewCart();
    await loadCatalogue();
    await loadParksDropdown();
    await loadParkSummary();
  }

  function checkpll() {
    const someuid = localStorage.getItem('uid');
    if (someuid === '901') {
      window.location.href = 'loginerror.html';
    }
  }

/* BROKEN CODE */

let newlyAddedQty = 0;
let totalPrice = 0;
let totalQty = 0;
let somecartid = 0;

async function addSelectedToCart() {
  const selected = document.getElementById('selected');
  const urlParams = new URLSearchParams(window.location.search);
  const parkId = parseInt(urlParams.get("parkId")) || 0;
  const shopId = parkId;

  if (!cartId) {
    alert('Cart has not been created yet. Please wait or try again.');
    console.error('Attempted to save CartItems without a valid cartId.');
    return;
  }

  const items = Array.from(selected.options);
  if (items.length === 0) {
    alert('Please select at least one item to add to cart.');
    return;
  }

  let newlyAddedQty = 0;
  let totalPrice = 0;
  let totalQty = 0;
  let somecartid = cartId;

  for (const option of items) {
    const qty = 1;
    const price = parseFloat(option.dataset.price);

    if (isNaN(price) || price <= 0) {
      console.warn(`Invalid price for item:`, option);
      continue;
    }

    const today = new Date().toISOString().split('T')[0]; 
    const cartItem = {
      cartid: parseInt(cartId),
      itemdescription: option.text || "Unnamed Item",
      itemextendedprice: price,
      itemqty: qty,
      itemtotals: price * qty,
      parkid: "11",
      shopid: "20",
      resStart: today,
      resEnd: today,
    };

    try {
      await $.ajax({
        url: "https://gridactions3b.547bikes.info/api/CartItem",
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(cartItem)
      });

      newlyAddedQty += qty;
      totalPrice += price * qty;
      totalQty += qty;
      somecartid = cartItem.cartid;
      console.log("✅ Item saved:", option.text);
    } catch (err) {
      console.error("❌ Error saving item:", err);
      alert(`Failed to save item: ${option.text}`);
    }
  }

  // ✅ Update cart master once after all items are added
  try {
   	updateCartTotals(somecartid);
    await updateCartMaster(somecartid, totalQty, totalPrice);
    console.log("🛒 Cart master updated.");
  } catch (err) {
    console.error("❌ Error updating cart master:", err);
    alert("Failed to update cart totals.");
  }
}


async function updateCartMaster(somecartid, someqty, sometransactiontotal) {
  const cartUpdate = {
    cartId: somecartid,
    parkId: parseInt(parkId),
    quantity: someqty,
    transactiontotal: sometransactiontotal,
    totalcartitems: someqty
  };

  alert("updating cart", JSON.stringify(cartUpdate));

  try {
    await $.ajax({
      url: `https://gridactions3b.547bikes.info/api/Cart/${somecartid}`,
      method: "PUT",
      contentType: "application/json",
      data: JSON.stringify(cartUpdate),
      success: function () {
        console.log("✅ Cart updated:", cartUpdate);
        alert(`${newlyAddedQty} item(s) added to cart`);
        selected.innerHTML = '';
        window.location.href = `cart5.html?uid=${encodeURIComponent(uid)}&parkId=${encodeURIComponent(parkId)}`;
      },
      error: function (xhr, status, error) {
        console.error("❌ Error updating cart:", status, error);
        alert("Failed to update cart totals.");
      }
    });
  } catch (err) {
    console.error("❌ Exception during cart update:", err);
    alert("Unexpected error updating cart.");
  }
}



    async function updateCartTotals(cartId) {
      try {
        const response = await fetch(`${baseUrl}/api/CartItem/cart/${cartId}`);
        const items = await response.json();

        let totalQty = 0;
        let totalPrice = 0;

        items.forEach(item => {
          totalQty += item.itemqty ?? 0;
          totalPrice += item.itemtotals ?? 0;
        });

      	let somedescription = "";
      	if(totalQty == 1)
        {
        somedescription = "Single Item";
        }
        else if(totalQty == 2)
        {
        somedescription = "Two Items";
        }
        else
        {
        somedescription = "More Than Two Items in Cart";
        }
         
      
        const cartUpdate = {
          totalcartitems: totalQty,
          transactiontotal: totalPrice,
          parkId: someparkId,
          parkname: someparkname,
          itemDescription: somedescription
        };
        console.log(cartUpdate);
      
        await fetch(`${baseUrl}/api/Cart/${cartId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cartUpdate)
        });

        console.log(`✅ Cart ${cartId} updated: ${totalQty} items, $${totalPrice.toFixed(2)}`);
        console.log(cartUpdate);
      } catch (err) {
        console.error("❌ Failed to update cart totals:", err);
      }
    }

window.addEventListener('beforeunload', function (event) {
  updateCartTotals(cartId);
});


</script>
<footer class="footer"> &copy; Cocky Consulting 2025. <br> All rights reserved.<br>  <span align="center"><a href="sitemap.html" class="sitelink">SiteMap</a></span></footer>
</html>