<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Maintenance</title>
  <link rel="stylesheet" href="login.css" />
  <link rel="stylesheet" href="dropmenu.css" />
  <script src="./js/bikes.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .header-image {
      height: 350px;
      width: 100%;
      object-fit: cover;
      margin-bottom: 20px;
    }
  
  button
  {
  width: 180px;
  
  }
  
  </style>
</head>
<body onload="checkpll(); checkUserStatus(); displayProfilePicture(); loadUsers()">
  <!-- Navigation Bar -->
  <div class="navbar">
    <div class="nav-left">
      <div class="dropdown">
        <button class="jsmenu"><img src="./images/jsmenu4.png" /></button>
        <div class="dropdown-content">
          <a href="index.html">Site Home</a>
          <a href="cartreview.html">MyCart</a>
          <a href="parks5.html">Review Park Options</a>
          <a href="parksreview5.html">Park Reviews</a>
          <a href="mybookings5.html">MyReservations</a>
          <a href="manager.html">Manager Utilities</a>
        </div>
      </div>
    <div class="logo"><H5>MyLinkv25 - Users</H5></div>
    </div>
    <div class="nav-right">
      <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
      <span id="H3UserBanner"></span>
      <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
      <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
              <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40px" height="40px"></a>
    </div>
  </div>

  <div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div>

  <div class="container">
    <img src="./images/people.jpg" alt="Mountain Biking" class="header-image" />
    <h2 class="mb-4">User List</h2>
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Quick Add</button>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Company ID</th>
          <th>Profile URL</th>
          <th>Select</th>
        </tr>
      </thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addUserForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">First Name</label><input type="text" class="form-control" id="firstname" required /></div>
            <div class="mb-3"><label class="form-label">Last Name</label><input type="text" class="form-control" id="lastname" required /></div>
            <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" id="username" required /></div>
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="email" required /></div>
            <div class="mb-3"><label class="form-label">Password</label><input type="password" class="form-control" id="plainpassword" required /></div>
            <div class="mb-3"><label class="form-label">Role</label><input type="text" class="form-control" id="role" required /></div>
            <div class="mb-3"><label class="form-label">ProfileUrl</label><input type="text" class="form-control" id="profileurl" required /></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

 <!-- Update User Modal -->
<div class="modal fade" id="updateUserModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="updateUserForm">
        <div class="modal-header">
          <h5 class="modal-title">Update User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updateId" />

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">First Name</label>
              <input type="text" class="form-control" id="updateFirstname" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-control" id="updateLastname" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="updateUsername" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="updateEmail" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="updatePlainpassword" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Role</label>
              <input type="text" class="form-control" id="updateRole" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Employee ID</label>
              <input type="text" class="form-control" id="updateEmployeeId" />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Company ID</label>
              <input type="number" class="form-control" id="updateCompanyId" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Profile URL</label>
              <input type="text" class="form-control" id="updateProfileUrl" />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">UID String</label>
              <input type="text" class="form-control" id="updateUidString" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Is Certified</label>
              <input type="number" class="form-control" id="updateIsCertified" />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Two-Factor Enabled</label>
              <input type="number" class="form-control" id="updateTwoFactorEnabled" />
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Two-Factor Type</label>
              <input type="text" class="form-control" id="updateTwoFactorType" />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" id="updateFullname" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
 
  <script>
  const API_USER = "https://parksapi.547bikes.info/api/User";
  const API_USER_ADD = "https://parksapi.547bikes.info/api/User/userfull";
  const API_PROFILE = "https://parksapi.547bikes.info/api/Userprofile";

  function loadUsers() {
    $.getJSON(API_USER, function (data) {
      const table = $("#userTable");
      table.empty();
      data.forEach(user => {
        table.append(`
          <tr>
            <td>${user.id}</td>
            <td>${user.firstname} ${user.lastname}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${user.companyid}</td>
            <td>${user.activepictureurl}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick='selectUser(${JSON.stringify(user)})'>
                Update Selected
              </button>
            </td>
          </tr>
        `);
      });
    });
  }

  function selectUser(user) {
    $("#updateId").val(user.id);
    $("#updateFirstname").val(user.firstname);
    $("#updateLastname").val(user.lastname);
    $("#updateUsername").val(user.username);
    $("#updateEmail").val(user.email);
    $("#updatePlainpassword").val(user.plainpassword || "");
    $("#updateRole").val(user.role);
    $("#updateProfileUrl").val(user.activepictureurl);
    $("#updateEmployeeId").val(user.employeeid);
    $("#updateCompanyId").val(user.companyid);
    $("#updateUidString").val(user.uidstring);
    $("#updateIsCertified").val(user.iscertified);
    $("#updateTwoFactorEnabled").val(user.usertwofactorenabled);
    $("#updateTwoFactorType").val(user.usertwofactortype);
    $("#updateFullname").val(user.fullname);
    $("#updateUserModal").modal("show");
  }

  // ADD USER
  $("#addUserForm").submit(function (e) {
    e.preventDefault();

    const firstname = $("#firstname").val();
    const lastname = $("#lastname").val();
    const username = $("#username").val();
    const email = $("#email").val();
    const plainpassword = $("#plainpassword").val();
    const role = $("#role").val();
    const profileurl = $("#profileurl").val();
    const fullname = `${firstname} ${lastname}`;

    if (!username || !email || !plainpassword || !fullname || !profileurl) {
      alert("Please fill in all required fields.");
      return;
    }

    const userPayload = {
      firstname,
      lastname,
      username,
      email,
      plainpassword,
      role,
      fullname,
      activepictureurl: profileurl,
      employeeid: "0",
      iscertified: 0,
      usertwofactorenabled: 0,
      };

    $.ajax({
      url: API_USER_ADD,
      method: "POST",
      contentType: "application/json",
      data: JSON.stringify(userPayload),
      success: function () {
        $("#addUserModal").modal("hide");
        $("#addUserForm")[0].reset();
        loadUsers();
      },
      error: function (xhr) {
        console.error("User creation failed:", xhr.responseText);
      }
    });
  });

 
    document.getElementById("updateUserForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const id = document.getElementById("updateId").value;
    const firstname = document.getElementById("updateFirstname").value;
    const lastname = document.getElementById("updateLastname").value;
    const username = document.getElementById("updateUsername").value;
    const email = document.getElementById("updateEmail").value;
    const plainpassword = document.getElementById("updatePlainpassword").value;
    const role = document.getElementById("updateRole").value;
    const employeeid = document.getElementById("updateEmployeeId").value;
    const companyid = document.getElementById("updateCompanyId").value;
    const activepictureurl = document.getElementById("updateProfileUrl").value;
    const uidstring = document.getElementById("updateUidString").value;
    const iscertified = document.getElementById("updateIsCertified").value;
    const usertwofactorenabled = document.getElementById("updateTwoFactorEnabled").value;
    const usertwofactortype = document.getElementById("updateTwoFactorType").value;
    const fullname = document.getElementById("updateFullname").value;
    const userid = id;

    if (!id || !username || !email || !fullname || !activepictureurl) {
      alert("Please fill in all required fields.");
      return;
    }

    const userPayload = {
      id: parseInt(id),
      userid: parseInt(userid),
      firstname,
      lastname,
      username,
      email,
      plainpassword,
      activepictureurl,
      fullname
    };

    console.log("Sending update payload:", userPayload);

    fetch(`https://parksapi.547bikes.info/api/User/user/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(userPayload)
    })
    .then(response => {
  if (!response.ok) {
    return response.text().then(text => {
      throw new Error(`Error ${response.status}: ${text}`);
    });
  }

  // âœ… Only parse JSON if there's content
  const contentType = response.headers.get("content-type");
  if (response.status === 204 || !contentType || !contentType.includes("application/json")) {
    return {}; // skip parsing
  }

  return response.json();
})
    .then(data => {
      console.log("User updated successfully:", data);
      const modal = bootstrap.Modal.getInstance(document.getElementById("updateUserModal"));
      modal.hide();
      document.getElementById("updateUserForm").reset();
      loadUsers();
    })
    .catch(error => {
      console.error("Update failed:", error.message);
    });
  });

  // Load users on page ready
  $(document).ready(function () {
    loadUsers();
  });
</script>







</body>
<footer class="footer text-center mt-5 mb-3">
  &copy; Cocky Consulting 2025.<br>All rights reserved.<br>
  <a href="sitemap.html" class="sitelink">SiteMap</a>
</footer>
</html>