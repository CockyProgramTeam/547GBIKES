  <meta charset="UTF-8">
  <title>Complete Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="home.css" />
   <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body onload="checkUserStatus()">
    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="nav-left">
        <div class="logo">&nbsp&nbspComplete Payment</div>
      </div>
      <div class="nav-right">
        <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
        <span id="H3UserBanner">User</span>
      </div>
    </div>
<div class="container mt-5">
  <h2>Choose a Credit Card</h2>

  <table class="table table-bordered table-striped mt-4">
    <thead class="table-dark">
      <tr>
        <th>Card Type</th>
        <th>Vendor</th>
        <th>Last 4 Digits</th>
        <th>Expiration</th>
        <th>Billing Zip</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="card-table-body"></tbody>
  </table>

  <div id="no-card-message" class="mt-3 text-danger fw-bold"></div>
  <button id="add-card-button" class="btn btn-secondary mt-2" data-bs-toggle="modal" data-bs-target="#addCardModal">Add Card</button>

  <div id="payment-status" class="mt-4"></div>

  <!-- Modal -->
  <div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="add-card-form" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCardModalLabel">Add New Card</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="card-uid">
          <div class="mb-3">
            <label for="cardType" class="form-label">Card Type</label>
            <input type="text" class="form-control" id="cardType" required>
          </div>
          <div class="mb-3">
            <label for="cardVendor" class="form-label">Card Vendor</label>
            <input type="text" class="form-control" id="cardVendor" required>
          </div>
          <div class="mb-3">
            <label for="cardLast4" class="form-label">Last 4 Digits</label>
            <input type="text" class="form-control" id="cardLast4" maxlength="4" required>
          </div>
          <div class="mb-3">
            <label for="cardExpDate" class="form-label">Expiration Date</label>
            <input type="text" class="form-control" id="cardExpDate" placeholder="MM/YY" required>
          </div>
          <div class="mb-3">
            <label for="billingZip" class="form-label">Billing Zip</label>
            <input type="text" class="form-control" id="billingZip" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Card</button>
        </div>
      </form>
    </div>
  </div>
</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseUrl = "https://gridactions3b.547bikes.info";
    const cardApi = `${baseUrl}/api/Card`;
    const paymentApi = `${baseUrl}/api/Payments`;

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid") || "1";
    const amount = urlParams.get("amount") || "0.00";
    const cartIds = urlParams.get("cartIds")?.split(",") || [];

    document.getElementById("card-uid").value = uid;

    async function fetchCards(uid) {
      const url = `${cardApi}?uid=${uid}`;
      console.log("Fetching cards from:", url);
      const response = await fetch(url);
      const cards = await response.json();
      console.log("Raw card data:", cards);
      return cards;
    }

    function renderCards(cards) {
      const tbody = document.getElementById("card-table-body");
      tbody.innerHTML = "";
      const noCardMsg = document.getElementById("no-card-message");
      const addCardBtn = document.getElementById("add-card-button");

      if (!cards || cards.length === 0) {
        noCardMsg.textContent = "No credit card on file.";
        addCardBtn.style.display = "inline-block";
        alert("No card on file. Please add one to proceed.");
        return;
      }

      noCardMsg.textContent = "";
      //addCardBtn.style.display = "none";

      cards.forEach(card => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${card.cardType}</td>
          <td>${card.cardVendor}</td>
          <td>${card.cardLast4}</td>
          <td>${card.cardExpDate}</td>
          <td>${card.billingZip}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="simulatePayment(${JSON.stringify(card)})">
              Pay $${amount}
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

   async function simulatePayment(card) {
  const transactionId = generateTransactionId();
  const paymentData = {
    paymentId: 0,
    bookingId: 0,
    paymentMethod: "Credit Card",
    cardType: card.cardType,
    cardLast4: card.cardLast4,
    cardExpDate: card.cardExpDate,
    amountPaid: parseFloat(amount),
    paymentDate: new Date().toISOString(),
    transactionId: transactionId
  };

  const paymentUrl = `${baseUrl}/api/Payments`;
  console.log("Submitting payment to:", paymentUrl);
  console.log("Transaction ID:", transactionId);

  try {
    await fetch(paymentUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(paymentData)
    });

    alert("Transaction complete!");

    document.getElementById("payment-status").innerHTML = `
      <p class="fw-bold text-success">✅ Payment of $${amount} processed using card ending in ${card.cardLast4}.</p>
      <p>Transaction ID: <strong>${transactionId}</strong></p>
      <p>Cart IDs: ${cartIds.join(", ")}</p>
      <p>User ID: ${uid}</p>
    `;
  } catch (err) {
    console.error("Error submitting payment:", err);
    document.getElementById("payment-status").innerHTML = `
      <p class="text-danger">❌ Payment failed. Please try again.</p>
    `;
  }
}

function generateTransactionId() {
  const letters = Array.from({ length: 3 }, () =>
    String.fromCharCode(65 + Math.floor(Math.random() * 26))
  ).join("");
  const digits = Math.floor(100000000 + Math.random() * 900000000).toString();
  return letters + digits;

    document.getElementById("add-card-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      const newCard = {
        cardId: 0,
        uid: uid,
        cardType: document.getElementById("cardType").value,
        cardVendor: document.getElementById("cardVendor").value,
        cardLast4: document.getElementById("cardLast4").value,
        cardExpDate: document.getElementById("cardExpDate").value,
        billingZip: document.getElementById("billingZip").value,
        isActive: 1
      };

      console.log("Adding new card:", newCard);

      try {
        const response = await fetch(cardApi, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newCard)
        });

        if (!response.ok) throw new Error("Card submission failed");

        const resultText = await response.text();
        const result = resultText ? JSON.parse(resultText) : null;
        console.log("Card added:", result);

        const modal = bootstrap.Modal.getInstance(document.getElementById("addCardModal"));
        modal.hide();

        await refreshCards();
      } catch (err) {
        console.error("Error adding card:", err);
        alert("Failed to add card. Please try again.");
      }
    });

    async function refreshCards() {
      const cards = await fetchCards(uid);
      renderCards(cards);
    }

    refreshCards();
  </script>
</body>
   <!-- Footer -->
  <footer class="footer"> &copy; Cocky Consulting 2025. <br> All rights reserved.<br>  <span align="center"><a href="sitemap.html" class="sitelink">SiteMap</a></span></footer>

</html>
