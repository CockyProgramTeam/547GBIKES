  <meta charset="UTF-8">
  <title>Payment Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="home.css" />
   <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body onload="checkUserStatus()">
    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="nav-left">
        <div class="logo">Simulate Payment</div>
      </div>
      <div class="nav-right">
        <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
        <span id="H3UserBanner">User</span>
      </div>
    </div>
<div class="container mt-5">
  <h2>Choose a Credit Card</h2>
  <table class="table table-bordered table-striped mt-4">
    <thead class="table-dark">
      <tr>
        <th>Card Type</th>
        <th>Vendor</th>
        <th>Last 4 Digits</th>
        <th>Expiration</th>
        <th>Billing Zip</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="card-table-body"></tbody>
  </table>

  <div id="payment-status" class="mt-4"></div>
</div>
  <script>
    const baseUrl = "https://parksapi.547bikes.info";
    const cardApi = `${baseUrl}/api/Card`;
    const paymentApi = `${baseUrl}/api/Payments`;

    const urlParams = new URLSearchParams(window.location.search);
    const uid = urlParams.get("uid") || "1";
    const amount = urlParams.get("amount") || "0.00";
    const cartIds = urlParams.get("cartIds")?.split(",") || [];

    async function fetchCards(uid) {
      const url = `${cardApi}?uid=${uid}`;
      console.log("Fetching cards from:", url);
      const response = await fetch(url);
      const cards = await response.json();
      console.log("Raw card data:", cards);
      return cards;
    }

    function renderCards(cards) {
      const tbody = document.getElementById("card-table-body");

      cards.forEach(card => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${card.cardType}</td>
          <td>${card.cardVendor}</td>
          <td>${card.cardLast4}</td>
          <td>${card.cardExpDate}</td>
          <td>${card.billingZip}</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="simulatePayment(${JSON.stringify(card)})">
              Pay $${amount}
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function simulatePayment(card) {
      const transactionId = "TXN" + Math.floor(Math.random() * 1000000); // Simulated transaction ID
      const paymentData = {
        paymentId: 0,
        bookingId: 0,
        paymentMethod: "Credit Card",
        cardType: card.cardType,
        cardLast4: card.cardLast4,
        cardExpDate: card.cardExpDate,
        amountPaid: parseFloat(amount),
        paymentDate: new Date().toISOString(),
        transactionId: transactionId
      };

      console.log("Submitting payment:", paymentData);

      try {
        const response = await fetch(paymentApi, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(paymentData)
        });

        if (!response.ok) throw new Error("Payment submission failed");

        const result = await response.json();
        console.log("Payment response:", result);

        document.getElementById("payment-status").innerHTML = `
          <p class="fw-bold text-success">✅ Payment of $${amount} processed using card ending in ${card.cardLast4}.</p>
          <p>Transaction ID: <strong>${transactionId}</strong></p>
          <p>Cart IDs: ${cartIds.join(", ")}</p>
          <p>User ID: ${uid}</p>
        `;
      } catch (err) {
        console.error("Error submitting payment:", err);
        document.getElementById("payment-status").innerHTML = `
          <p class="text-danger">❌ Payment failed. Please try again.</p>
        `;
      }
    }

    fetchCards(uid).then(renderCards).catch(err => {
      console.error("Error fetching cards:", err);
      document.getElementById("payment-status").innerHTML = `
        <p class="text-danger">❌ Failed to load credit card data.</p>
      `;
    });
  </script>
</body>
</html>
