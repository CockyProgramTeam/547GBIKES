<!DOCTYPE html>
<html>
<head>
    <title>Payments Grid</title>
  <link rel="stylesheet" href="login.css" />
  <link rel="stylesheet" href="dropmenu.css" />
  <script src="./js/bikes.js"></script>
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        th.sortable { cursor: pointer; }
        th.sortable:after { content: " â‡…"; font-size: 0.8rem; color: #bbb; }
    </style>
</head>

<body class="bg-light" onload="checkpll(); checkUserStatus(); displayProfilePicture();">
    <!-- Navigation Bar -->
    <div class="navbar">
      <div class="nav-left">
            <div class="dropdown">
                  <button class="jsmenu"><img src="./images/jsmenu4.png"></button> 
                  <div class="dropdown-content">
                  <a href="index.html">Site Home</a>
                  <a href="cartreview.html">MyCart</a>
                  <a href="parks5.html">Review Park Options</a>
                  <a href="parksreview5.html">Park Reviews</a>
                  <a href="mybookings5.html">MyReservations</a>
                  <a href="manager.html">Manager Utilities</a>
             </div>
    </div> 
      <div class="logo">&nbsp&nbsp<H5>MyLinkv25 - Review Parks</H5></div>
      </div>
      <div class="nav-right">
        <img src="./images/bluecircle.png" id="profilephototarget" alt="User" style="cursor:pointer;" onclick="window.location.href='profile.html'" />
        <span id="H3UserBanner"></span>
        <a href="login.html" id="loginBtn" class="btn secondary-btn" onclick="loginUser(event)">Login</a>
        <a href="login.html" id="logoutBtn" class="btn secondary-btn" onclick="logoutUser(event)">Logout</a>
                <a href="cartreview.html" id="cartBtn3"><img src="./images/cart4.png" width="40px" height="40px"></a>
      </div>
    </div>
<div align="center" id="banner"><span id="userGreeting">Welcome Guest</span></div>
<div class="container mt-5">

    <h2 class="mb-4">Payments Administrator</h2>

    <!-- FILTERS + SEARCH -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label class="form-label">Filter by State</label>
            <select id="stateFilter" class="form-select">
                <option value="">All States</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Filter by Park</label>
            <select id="parkFilter" class="form-select">
                <option value="">All Parks</option>
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Search</label>
            <input id="searchBox" type="text" class="form-control" placeholder="Search payments...">
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button id="clearFilters" class="btn btn-secondary w-100">Clear Filters</button>
        </div>
    </div>

    <!-- TABLE -->
    <table class="table table-striped table-bordered" id="paymentsTable">
        <thead class="table-dark">
            <tr>
                <th class="sortable" data-field="paymentId">Payment ID</th>
                <th class="sortable" data-field="bookingId">Booking ID</th>
                <th class="sortable" data-field="paymentMethod">Method</th>
                <th class="sortable" data-field="cardType">Card Type</th>
                <th class="sortable" data-field="cardLast4">Last 4</th>
                <th class="sortable" data-field="amountPaid">Amount</th>
                <th class="sortable" data-field="paymentDate">Date</th>
                <th class="sortable" data-field="transactionId">Transaction ID</th>
                <th class="sortable" data-field="refundId">Refund ID</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

<script>
    let allPayments = [];
    let sortField = null;
    let sortDirection = 1;

    async function loadPayments() {
        const url = "https://parksapi.547bikes.info/api/Payments";

        try {
            const response = await fetch(url);
            const data = await response.json();
            allPayments = data;

            populateFilters(data);
            renderTable(data);

        } catch (err) {
            console.error("Error loading payments:", err);
        }
    }

    function populateFilters(data) {
        const stateSelect = document.getElementById("stateFilter");
        const parkSelect = document.getElementById("parkFilter");

        // If your API includes state/park fields, update these:
        const states = [...new Set(data.map(p => p.state).filter(Boolean))];
        const parks = [...new Set(data.map(p => p.parkName).filter(Boolean))];

        states.forEach(state => {
            stateSelect.insertAdjacentHTML("beforeend", `<option value="${state}">${state}</option>`);
        });

        parks.forEach(park => {
            parkSelect.insertAdjacentHTML("beforeend", `<option value="${park}">${park}</option>`);
        });

        stateSelect.addEventListener("change", applyFilters);
        parkSelect.addEventListener("change", applyFilters);
        document.getElementById("searchBox").addEventListener("input", applyFilters);
        document.getElementById("clearFilters").addEventListener("click", clearFilters);

        document.querySelectorAll("th.sortable").forEach(th => {
            th.addEventListener("click", () => sortBy(th.dataset.field));
        });
    }

    function clearFilters() {
        document.getElementById("stateFilter").value = "";
        document.getElementById("parkFilter").value = "";
        document.getElementById("searchBox").value = "";
        sortField = null;
        applyFilters();
    }

    function applyFilters() {
        const state = document.getElementById("stateFilter").value;
        const park = document.getElementById("parkFilter").value;
        const search = document.getElementById("searchBox").value.toLowerCase();

        let filtered = allPayments;

        if (state) filtered = filtered.filter(p => p.state === state);
        if (park) filtered = filtered.filter(p => p.parkName === park);

        if (search) {
            filtered = filtered.filter(p =>
                Object.values(p).some(v =>
                    String(v).toLowerCase().includes(search)
                )
            );
        }

        if (sortField) {
            filtered.sort((a, b) => {
                const valA = a[sortField] ?? "";
                const valB = b[sortField] ?? "";
                return valA > valB ? sortDirection : -sortDirection;
            });
        }

        renderTable(filtered);
    }

    function sortBy(field) {
        if (sortField === field) {
            sortDirection *= -1;
        } else {
            sortField = field;
            sortDirection = 1;
        }
        applyFilters();
    }

    function renderTable(data) {
        const tbody = document.querySelector("#paymentsTable tbody");
        tbody.innerHTML = "";

        data.forEach(p => {
            const row = `
                <tr>
                    <td>${p.paymentId}</td>
                    <td>${p.bookingId}</td>
                    <td>${p.paymentMethod}</td>
                    <td>${p.cardType}</td>
                    <td>${p.cardLast4}</td>
                    <td>${p.amountPaid}</td>
                    <td>${p.paymentDate}</td>
                    <td>${p.transactionId}</td>
                    <td>${p.refundTransactionId}</td>
                </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
        });
    }

    loadPayments();
</script>

</body>
<!-- Footer -->
<footer class="footer"> &copy; Cocky Consulting 2025. <br> All rights reserved.<br>  <span align="center"><a href="sitemap.html" class="sitelink">SiteMap</a></span></footer>
</html>
